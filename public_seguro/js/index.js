try{window.tailwind=window.tailwind||{},window.tailwind.config={theme:{extend:{fontFamily:{inter:["Inter","system-ui","sans-serif"]},colors:{brand:{50:"#E6F1FF",100:"#CCE3FF",200:"#99C6FF",300:"#66A8FF",400:"#338BFF",500:"#006DFF",600:"#0058CC",700:"#004399",800:"#002E66",900:"#001933"}}}}}}catch(e){}(()=>{const e=document.querySelectorAll("#main-tabs .tab-btn"),t={carousel:document.getElementById("tab-carousel"),text:document.getElementById("tab-text"),qr:document.getElementById("tab-qr")};function n(n){if(e.forEach((e=>{const t=e.dataset.tab===n;try{e.classList.remove("bg-white/10","bg-white/5","bg-emerald-500/20","bg-emerald-500/30"),e.classList.add(t?"bg-emerald-500/30":"bg-emerald-500/20")}catch(n){const o=e.className.replace(/\b(bg-(white|emerald)-\d+\/\d+|bg-white\/(5|10))\b/g,"").trim();e.className=o+" "+(t?"bg-emerald-500/30":"bg-emerald-500/20")}})),Object.entries(t).forEach((([e,t])=>{t&&t.classList.toggle("hidden",e!==n)})),"qr"===n)try{"function"==typeof window.initUserInstanceQrTab&&window.initUserInstanceQrTab()}catch(e){}}window.activateTab=n,e.forEach((e=>e.addEventListener("click",(()=>n(e.dataset.tab)))));try{const e=(new URLSearchParams(window.location.search).get("tab")||"").trim();n(["carousel","text","qr"].includes(e)?e:"carousel")}catch(e){n("carousel")}})(),(()=>{const e=document.getElementById("admin-tab-btn");if(!e)return;const t=Boolean(localStorage.getItem("adminToken"))||"admin"===localStorage.getItem("authRole");e.style.display=t?"inline-flex":"none",e.addEventListener("click",(()=>{window.location.href="/admin"}))})(),(()=>{const e=document.getElementById("logout-btn");if(!e)return;const t=Boolean(localStorage.getItem("adminToken"))||Boolean(localStorage.getItem("authRole"));e.style.display=t?"inline-flex":"none",e.addEventListener("click",(()=>{try{localStorage.removeItem("authToken"),localStorage.removeItem("adminToken"),localStorage.removeItem("authRole"),localStorage.removeItem("authUser")}catch(e){}try{window.authFetch("/logout",{method:"POST"})}catch(e){}window.location.href="/login"}))})(),(()=>{const e=(e,t)=>{const n=(e=>document.getElementById(e))(e);n&&n.addEventListener("click",(e=>{try{e&&"function"==typeof e.preventDefault&&e.preventDefault()}catch(e){}try{e&&"function"==typeof e.stopPropagation&&e.stopPropagation()}catch(e){}try{const e=window[t];if("function"==typeof e)return e();console.warn(`[index.js] função não encontrada: ${t}`)}catch(e){console.warn(`[index.js] erro ao chamar ${t}:`,e?.message||String(e))}}))};e("add-carousel-card-btn","addCarouselCard"),e("send-carousel-btn","enviarCarrossel"),e("send-text-btn","sendSimpleText"),e("qr-create-btn","qrCreateInstance"),e("qr-connect-btn","qrConnectThenForceQr"),e("qr-status-btn","qrGetStatus"),e("qr-copy-btn","qrCopyPaircode")})(),(()=>{const e=document.getElementById("carouselTemplate");e&&e.addEventListener("change",(()=>{try{"function"==typeof window.loadCarouselTemplate&&window.loadCarouselTemplate()}catch(e){}}))})(),async function(){try{const e=document.getElementById("qr-instance");if(!e)return;if(e.value&&e.value.trim())return;const t=await window.authFetch("/me",{method:"GET"}),n=await t.json().catch((()=>({}))),o=n&&n.user&&n.user.username?String(n.user.username).trim():"";try{const t="function"==typeof window.normalizeInstanceName?window.normalizeInstanceName(o):String(o).toLowerCase().replace(/[^a-z0-9-]+/g,"-").replace(/-+/g,"-").replace(/^-+|-+$/g,"").slice(0,32);t&&(e.value=t)}catch(t){o&&(e.value=o)}}catch(e){}}(),(()=>{const e=e=>document.getElementById(e),t=e("rt-banner"),n=e("rt-banner-text"),o=e("rt-banner-sub"),a=e("rt-banner-close"),r=e("rt-banner-go");function c(e,a){n&&(n.textContent=e||"Conectado com sucesso"),o&&(o.textContent=a||""),t&&(t.style.display="")}a&&a.addEventListener("click",(function(){t&&(t.style.display="none")})),r&&r.addEventListener("click",(function(){try{if("function"==typeof window.activateTab)return window.activateTab("text")}catch(e){}window.location.href="/painel/envio"})),async function(){try{let e=null;try{const t=await window.authFetch("/me",{method:"GET"}),n=await t.json().catch((()=>({})));e=n?.user?.id||null}catch(e){}if(!e)return;let t=null;try{t=window.io?window.io():null}catch(e){return void console.warn("[Socket.IO] indisponível no frontend:",e?.message||String(e))}if(!t)return;try{t.emit("register",{user_id:e})}catch(e){}const n=`instance_connected:${e}`,o=async()=>{try{const e={instance:"",deviceName:"",phone:""};try{const t=await window.authFetch("/user/instance-status",{method:"GET"}),n=await t.json().catch((()=>({})));e.instance=n?.instance_name||n?.instance||"",e.deviceName=n?.deviceName||n?.status?.deviceName||"",e.phone=n?.phoneNumber||n?.status?.phoneNumber||""}catch(e){}const t=[];e.instance&&t.push(`Instância: ${e.instance}`),e.deviceName&&t.push(`Dispositivo: ${e.deviceName}`),e.phone&&t.push(`Número: ${e.phone}`),c("WhatsApp conectado",t.join(" • "))}catch(e){c("WhatsApp conectado","Conexão confirmada.")}};t.on(n,o),t.on("instance_connected",o),console.log("[Socket.IO] ouvindo",n)}catch(e){console.warn("[RealtimeBanner] falhou:",e?.message||String(e))}}()})(),function(){function e(e){if(!e)return!1;const t=String(e).trim();return!!/^https?:\/\//i.test(t)||(!!/^www\./i.test(t)||!!/^[a-z0-9.-]+\.[a-z]{2,}(\/.*)?$/i.test(t))}window.isUrlLike=e;const t=window.APP_API||null,n=t&&t.proxyBaseUrl?t.proxyBaseUrl:window.location.origin,o=t&&t.urls&&t.urls.sendText?t.urls.sendText:`${n}/send-simple-text`,a=t&&t.urls&&t.urls.configureWebhook?t.urls.configureWebhook:`${n}/configure-webhook`,r=`${n}/get-qr-code`;window.__APP_API_BASE={__api:t,__base:n,__sendTextUrl:o,__configureWebhookUrl:a,__getQrUrl:r};const c=document.getElementById("ai-validate");c&&c.addEventListener("click",(()=>{const t=[];document.querySelectorAll(".card-editor").forEach((n=>{const o=n.getAttribute("data-card-id"),a=document.getElementById(`card-image-${o}`)?.value?.trim()||"";a&&e(a)||t.push(`Cartão #${o}: imagem deve ser um link válido (pode ser sem https).`);n.querySelectorAll(".button-editor").forEach(((n,a)=>{const r=document.getElementById(`button-type-${o}-${a}`)?.value||"";if(document.getElementById(`button-label-${o}-${a}`)?.value?.trim()||""||t.push(`Cartão #${o} Botão #${a+1}: falta label.`),"URL"===r){const n=document.getElementById(`button-url-${o}-${a}`)?.value?.trim()||"";n&&e(n)||t.push(`Cartão #${o} Botão #${a+1}: informe um link válido (pode ser sem https).`)}else if("CALL"===r){const e=document.getElementById(`button-phone-${o}-${a}`)?.value?.trim()||"";e&&/^\d{10,15}$/.test(e)||t.push(`Cartão #${o} Botão #${a+1}: informe um telefone válido com DDI (somente dígitos).`)}else if("COPY"===r){document.getElementById(`button-copy-${o}-${a}`)?.value?.trim()||""||t.push(`Cartão #${o} Botão #${a+1}: informe o texto para copiar (ex: CUPOM20).`)}}))}));const n=document.getElementById("log");n&&(0===t.length?n.innerText="✅ Validação Inteligente: nenhum problema encontrado.":n.innerText="⚠️ Validação Inteligente encontrou itens:\n"+t.map((e=>"- "+e)).join("\n"))}))}(),async function(){const e=document.getElementById("credits-badge");if(!e)return;const t=localStorage.getItem("authRole")||"";if(!Boolean(t))return void(e.style.display="none");const n=Number(localStorage.getItem("authCredits")||0);Number.isNaN(n)||(e.textContent="Créditos: "+n,e.style.display="inline-flex");try{const t=window.APP_API&&window.APP_API.proxyBaseUrl?window.APP_API.proxyBaseUrl:window.location.origin,n=await window.authFetch(t.replace(/\/$/,"")+"/me",{method:"GET"});if(!n.ok)return;const o=await n.json(),a=Number(o?.user?.credits||0);e.textContent="Créditos: "+a;try{localStorage.setItem("authCredits",String(a))}catch(e){}e.style.display="inline-flex"}catch(t){n||(e.textContent="Créditos: 0",e.style.display="inline-flex")}}(),async function(){const e=document.getElementById("expiry-badge");if(!e)return;const t=localStorage.getItem("authRole")||"";if(Boolean(t))if("admin"!==t)try{const t=window.APP_API&&window.APP_API.proxyBaseUrl?window.APP_API.proxyBaseUrl:window.location.origin,o=await window.authFetch(t.replace(/\/$/,"")+"/me",{method:"GET"});if(!o.ok)return e.textContent="Dias restantes: --",void(e.style.display="inline-flex");const a=await o.json(),r=Number(a?.user?.expires_at||0);if(!r)return e.textContent="Dias restantes: --",n(),void(e.style.display="inline-flex");const c=r-Date.now();if(c<=0)return e.textContent="Acesso expirado",function(){try{e.classList.remove("border-amber-400/50","bg-amber-500/10","text-amber-300"),e.classList.add("border-red-400/40","bg-red-500/20","text-red-200")}catch(e){}}(),void(e.style.display="inline-flex");const i=Math.ceil(c/864e5);e.textContent="Dias restantes: "+i,n(),e.style.display="inline-flex"}catch(t){e.textContent="Dias restantes: --",n(),e.style.display="inline-flex"}else e.style.display="none";else e.style.display="none";function n(){try{e.classList.remove("border-red-400/40","bg-red-500/20","text-red-200"),e.classList.add("border-amber-400/50","bg-amber-500/10","text-amber-300")}catch(e){}}}(),document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("series-nav");e&&window.carouselTemplates&&(e.innerHTML="",window.carouselTemplates.forEach((t=>{const n=document.createElement("button");n.className="px-3 py-1 rounded-none border border-white/20 bg-white/5 hover:bg-white/10 text-sm",n.textContent=t.name,n.addEventListener("click",(()=>{const e=document.getElementById("carouselTemplate");e&&(e.value=t.id);try{"function"==typeof window.loadCarouselTemplate&&window.loadCarouselTemplate()}catch(e){}})),e.appendChild(n)})))})),function(){function e(e){const t=String(e||"").trim().toLowerCase();if(!t)return"";let n=t.replace(/\s+/g,"-").replace(/_/g,"-");return n=n.replace(/[^a-z0-9-]/g,"-"),n=n.replace(/-+/g,"-"),n=n.replace(/^-+|-+$/g,""),n.length>32&&(n=n.slice(0,32)),n}function t(e){const t=String(e||"");return!(t.length<3||t.length>32)&&/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(t)}window.normalizeInstanceName=e,window.isValidInstanceName=t;const{__base:n,__sendTextUrl:o,__configureWebhookUrl:a}=window.__APP_API_BASE||{};function r(e){const t=document.getElementById("qr-log");if(!t)return;const n=(new Date).toISOString();t.textContent+=`\n[${n}] ${e}`,t.scrollTop=t.scrollHeight}function c(e){const t=[e?.token,e?.raw?.token,e?.raw?.data?.token,e?.raw?.instance?.token,e?.instance?.token,e?.status?.token].filter((e=>"string"==typeof e&&e.trim()));return t.length?t[0]:""}function i(e){const t=e?.info||{},n=e?.status||{},o=[e?.qrCode,e?.qrcode,e?.qr,e?.base64,t?.qrCode,t?.qrcode,t?.qr,t?.base64,n?.qrCode,n?.qrcode,n?.qr,n?.base64,e?.url,t?.url,n?.url,n?.qr_url,n?.qr_image,n?.qr_image_base64,e?.raw?.instance?.qrcode,e?.raw?.instance?.qr_image,e?.raw?.status?.qrcode,e?.raw?.status?.qr_image,e?.raw?.qrcode,e?.raw?.data?.qrCode,e?.raw?.data?.qrcode,e?.raw?.data?.qr,e?.raw?.data?.base64,e?.raw?.data?.url,e?.raw?.data?.qr_image,e?.raw?.data?.qr_image_base64].filter((e=>"string"==typeof e&&e.trim()));return o.length?o[0]:""}function s(e){const t=e?.status||{},n=[e?.paircode,t?.paircode,e?.instance?.paircode,e?.raw?.instance?.paircode,e?.raw?.paircode].filter((e=>"string"==typeof e&&e.trim()));return n.length?n[0]:""}function d(e){try{let t="";if("string"==typeof e?.format){const n=e.format.toLowerCase();"url"===n&&"string"==typeof e?.url&&e.url.trim()?t=e.url.trim():"base64"!==n&&"dataurl"!==n||"string"!=typeof e?.qr||!e.qr.trim()||(t=e.qr.trim())}t||(t=i(e));const n=s(e),o=document.getElementById("qr-image"),a=document.getElementById("qr-status"),c=document.getElementById("qr-placeholder"),d=document.getElementById("paircodeDisplay");let l=document.getElementById("qr-open-link");if(n&&d&&(d.value=n),t){let n=t;"string"!=typeof n||n.startsWith("data:image")||n.startsWith("http")||(n=`data:image/png;base64,${n}`),o&&(o.src=n,o.onload=()=>{r("Imagem de QR carregada com sucesso.")},o.onerror=e=>{r(`Falha ao carregar imagem do QR: ${e?.message||"erro desconhecido"}`)},o.style.display="");try{window.qrFlowLog&&window.qrFlowLog("qr.flow.qr_shown",{page:"index.js",is_http_url:"string"==typeof t&&t.startsWith("http")})}catch(e){}if("string"==typeof t&&t.startsWith("http")){if(!l){l=document.createElement("a"),l.id="qr-open-link",l.textContent="Abrir QR em nova aba",l.target="_blank",l.rel="noopener noreferrer",l.className="underline text-emerald-300 ml-2";const e=document.getElementById("paircode-section")||document.getElementById("qr-status")||o&&o.parentNode;try{e&&e.parentNode&&e.parentNode.insertBefore(l,e.nextSibling)}catch(e){}}try{l.href=t,l.style.display=""}catch(e){}}else if(l)try{l.style.display="none"}catch(e){}c&&(c.style.display="none"),a&&(a.textContent="QR atualizado. Escaneie no WhatsApp para parear.");try{r("Payload recebido para QR: "+JSON.stringify(e))}catch(e){}}else{if(o&&(o.style.display="none"),l)try{l.style.display="none"}catch(e){}c&&(c.style.display=""),a&&(a.textContent="QR não encontrado no payload. Use Status ou Forçar QR.");try{window.qrFlowLog&&window.qrFlowLog("qr.flow.qr_hidden",{page:"index.js",reason:"no_qr_in_payload",payload_keys:Object.keys(e||{})})}catch(e){}try{r("Payload sem QR detectável: "+JSON.stringify(e))}catch(e){}}}catch(e){r(`Erro ao renderizar QR: ${e.message}`)}}async function l(e){const t=new URL(`${n}/user/get-qr-code`);t.searchParams.set("force",e?"true":"false");try{const n=await window.authFetch(t.toString(),{method:"GET"}),o=n.headers.get("content-type")||"",a=o.includes("application/json")?await n.json().catch((()=>({}))):{};if(n.ok)return r(e?"Novo QR solicitado (force=true).":"QR solicitado."),void d(a);if(400===n.status){const e=a?.error||a?.message||"Requisição inválida (400).";if(/manual/i.test(e)||/MANUAL_INSTANCE_MODE/i.test(e))r("Modo manual ativo: informe nome da instância, crie e vincule token antes de conectar.");else if(/token/i.test(e)||/PROV_TOKEN/i.test(e))r('Token da instância ausente/ inválido. Preencha o campo "Token" ou crie a instância para obter automaticamente.');else try{r("Erro 400 ao obter QR: "+JSON.stringify(a,null,2))}catch(t){r(e)}}else{r(`Erro ao obter QR: ${a?.error||a?.message||`HTTP ${n.status}`}`)}}catch(e){r(`Erro de conexão ao obter QR: ${e.message}`)}}async function u(){const o=document.getElementById("qr-status"),a=document.getElementById("qr-image"),r=document.getElementById("qr-placeholder"),c=document.getElementById("qr-log"),i=e(document.getElementById("qr-instance")?.value?.trim()||"");if(t(i))if(i){o&&(o.textContent=`Desconectando instância "${i}"...`),a&&(a.style.display="none"),r&&(r.style.display=""),c&&(c.textContent="");try{const e=await window.authFetch(`${n}/disconnect-instance`,{method:"POST",headers:{"Content-Type":"application/json"},body:{instance:i},keepalive:!0}),t=e.headers.get("content-type")||"";let a;if(!t.includes("application/json")){const n=await e.text();return c&&(c.textContent=`⚠️ Resposta não-JSON recebida do proxy.\nStatus: ${e.status} ${e.statusText}\nContent-Type: ${t}\nCorpo bruto:\n${n}`),o&&(o.textContent="Falha ao desconectar instância"),o&&(o.textContent="Tentando reconectar e forçar novo QR..."),void await m()}if(a=await e.json(),e.ok&&a){Boolean(a.success||"disconnected"===a.status||a.reason)?(o&&(o.textContent="Instância desconectada (ou já sem conexão) — reconectando e forçando novo QR..."),await m()):(o&&(o.textContent="Falha ao desconectar instância — tentando reconectar e forçar novo QR..."),c&&(c.textContent=JSON.stringify(a,null,2)),await m())}else{if(400===e.status&&a){const e=a?.error||a?.message||"Parâmetros inválidos ao desconectar.";return void(o&&(o.textContent=`Erro 400 ao desconectar: ${e}`))}o&&(o.textContent=`Erro ao desconectar (HTTP ${e.status}) — tentando reconectar e forçar novo QR...`),c&&(c.textContent=JSON.stringify(a||{},null,2)),await m()}}catch(e){o&&(o.textContent="Erro de conexão ao desconectar — tentando reconectar e forçar novo QR..."),c&&(c.textContent="❌ Erro de conexão com o proxy:\n"+e.message),await m()}}else o&&(o.textContent="Informe o nome da instância para desconectar.");else o&&(o.textContent="Informe um nome válido (3–32, letras/números/hífen).")}async function m(){const o=document.getElementById("qr-phone")?.value?.trim()||"";if(!!(localStorage.getItem("authUser")||"").trim()){try{const o=await window.authFetch(`${n}/user/ensure-instance`,{method:"POST",headers:{"Content-Type":"application/json"},body:{}}),a=await o.json().catch((()=>({})));if(o.ok){const o=a?.instance_name||a?.instance||a?.name||"";if(o)try{const e=await window.authFetch(`${n}/user/bind-instance`,{method:"POST",headers:{"Content-Type":"application/json"},body:{instance:o}});await e.json().catch((()=>({}))),r(`Instância garantida para o usuário: ${o}`)}catch(e){}else{const o=e(document.getElementById("qr-instance")?.value?.trim()||"");if(o)if(t(o))try{r(`Criando instância manualmente: ${o} ...`);const e=await window.authFetch(`${n}/create-instance`,{method:"POST",headers:{"Content-Type":"application/json"},body:{name:o}}),t=await e.json().catch((()=>({})));if(e.ok){const e=c(t),a=document.getElementById("qr-token");e&&a&&(a.value=e);try{const t=await window.authFetch(`${n}/user/bind-instance`,{method:"POST",headers:{"Content-Type":"application/json"},body:{instance:o,token:e}});await t.json().catch((()=>({}))),r(`Instância criada e vinculada ao usuário: ${o}`)}catch(e){r(`Instância criada, mas falhou vincular ao usuário: ${e?.message||"erro"}`)}}else{r(`Falha ao criar instância: ${t?.error||t?.message||`HTTP ${e.status}`}`)}}catch(e){r(`Erro ao criar instância manualmente: ${e.message}`)}else r("Nome inválido. Use 3–32 caracteres: letras, números e hífen (sem hífen nas extremidades).");else r("Informe o nome da instância (campo acima) para criar e vincular.")}}}catch(e){}try{const e=await window.authFetch(`${n}/user/connect-instance`,{method:"POST",headers:{"Content-Type":"application/json"},body:{phone:o}}),t=await e.json();if(!e.ok)throw new Error(t?.error||`HTTP ${e.status}`);r("Conexão solicitada. Tentando forçar QR..."),d(t);try{const e=t?.instance||t?.name||document.getElementById("qr-instance")?.value?.trim()||"",n=document.getElementById("qr-token");n&&n.value&&String(n.value).trim();e&&function({instance:e,timeoutMs:t=12e4}){try{h()}catch(e){}if(!e)return;const n=`/qr-events?${new URLSearchParams({instance:e}).toString()}`;try{w=new EventSource(n),w.addEventListener("open",(()=>{r(`SSE aberto para ${e}`);try{window.qrFlowLog&&window.qrFlowLog("qr.flow.sse_open",{page:"index.js",instance:e})}catch(e){}})),w.addEventListener("status",(t=>{try{const n=JSON.parse(t.data||"{}");try{d({status:{qrcode:n.qrcode,paircode:n.paircode}})}catch(e){}if(Boolean(n.connected||["connected","ready"].includes(String(n.state||"").toLowerCase())))try{window.qrFlowLog&&window.qrFlowLog("qr.flow.sse_status_connected",{page:"index.js",instance:e})}catch(e){}}catch(e){}})),w.addEventListener("connected",(()=>{try{r("SSE: instância conectada.")}catch(e){}try{window.qrFlowLog&&window.qrFlowLog("qr.flow.sse_connected_event",{page:"index.js",instance:e})}catch(e){}})),w.addEventListener("error",(t=>{r(`SSE erro: ${t?.message||"desconhecido"}`);try{window.qrFlowLog&&window.qrFlowLog("qr.flow.sse_error",{page:"index.js",instance:e,error:t?.message||"desconhecido"})}catch(e){}})),y=setTimeout((()=>{try{window.qrFlowLog&&window.qrFlowLog("qr.flow.sse_timeout_no_confirm",{page:"index.js",instance:e,timeoutMs:t})}catch(e){}h()}),t)}catch(e){r(`Falha ao iniciar SSE: ${e.message}`)}}({instance:e,timeoutMs:12e4})}catch(e){}}catch(e){r(`Aviso: conexão não concluída imediatamente: ${e.message}. Prosseguindo com force QR.`)}try{await l(!0)}catch(e){}try{await new Promise((e=>setTimeout(e,2e3))),await l(!0)}catch(e){}try{await new Promise((e=>setTimeout(e,3e3))),await l(!0)}catch(e){}}else r("Faça login para conectar sua instância.")}window.initUserInstanceQrTab=async function(){try{const e=document.getElementById("qr-instance"),t=document.getElementById("qr-status"),o=await window.authFetch(`${n}/me`,{method:"GET"}),a=await o.json().catch((()=>({})));if(o.ok&&a&&a.user){const t=a.user.instance_name||"";t&&e&&(e.value=t)}const r=await window.authFetch(`${n}/user/instance-status`,{method:"GET"}),c=await r.json().catch((()=>({})));if(r.ok&&c&&c.status){const e=Boolean(c.status.connected),n=document.getElementById("qr-image"),o=document.getElementById("qr-placeholder");e?(t&&(t.textContent="✅ WhatsApp conectado. Você pode enviar mensagens agora."),n&&(n.style.display="none"),o&&(o.style.display="")):t&&(t.textContent="Aguardando conexão. Gere o QR e escaneie no WhatsApp.")}}catch(e){console.warn("[initUserInstanceQrTab] falha:",e)}},window.sendSimpleText=async function(){const e=document.getElementById("textPhone")?.value?.trim()||"",t=document.getElementById("textMessage")?.value?.trim()||"",n=document.getElementById("textLog");if(n)if(e&&t)try{n.innerText="Enviando texto simples...";const a=localStorage.getItem("authToken"),r=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",...a?{Authorization:`Bearer ${a}`}:{}},body:JSON.stringify({phone:e,message:t})}),c=r.headers.get("content-type")||"";let i;if(!c.includes("application/json")){const e=await r.text();return n.innerText=`⚠️ Resposta não-JSON recebida do proxy.\nStatus: ${r.status} ${r.statusText}\nContent-Type: ${c}\nCorpo bruto:\n${e}`,void console.warn("Resposta não-JSON do proxy (texto):",{status:r.status,contentType:c,rawText:e})}if(i=await r.json(),r.ok){n.innerText="✅ Sua mensagem foi enviada com sucesso — Unlock Center agradece";try{Swal.fire({icon:"success",title:"Mensagem enviada!",text:"Seu texto foi enviado com sucesso.",confirmButtonText:"Ok",customClass:{popup:"swal-red-custom"}})}catch(e){}}else n.innerText="❌ Erro ao enviar texto:\n"+JSON.stringify(i,null,2)}catch(e){n.innerText="❌ Erro de conexão com o proxy:\n"+e.message}else n.innerText="❌ Informe telefone e mensagem."},window.configureWebhook=async function(){const e=document.getElementById("publicUrl")?.value?.trim()||"",t=document.getElementById("webhookLog");if(t)if(e)try{t.innerText="Configurando webhook...";const n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({publicUrl:e})}),o=n.headers.get("content-type")||"";let r;if(!o.includes("application/json")){const e=await n.text();return t.innerText=`⚠️ Resposta não-JSON recebida do proxy.\nStatus: ${n.status} ${n.statusText}\nContent-Type: ${o}\nCorpo bruto:\n${e}`,void console.warn("Resposta não-JSON do proxy (webhook):",{status:n.status,contentType:o,rawText:e})}r=await n.json(),n.ok?t.innerText="✅ Webhook configurado:\n"+JSON.stringify(r,null,2):t.innerText="❌ Erro ao configurar webhook:\n"+JSON.stringify(r,null,2)}catch(e){t.innerText="❌ Erro de conexão com o proxy:\n"+e.message}else t.innerText="❌ Informe a URL pública."},window.qrLog=r,window.extractTokenFromPayload=c,window.extractQrFromPayload=i,window.extractPaircodeFromPayload=s,window.renderQrFromPayload=d,window.qrCreateInstance=async function(){const o=e(document.getElementById("qr-instance")?.value?.trim()||"");if(o)if(t(o))try{const e=await fetch(`${n}/create-instance`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:o})}),t=await e.json().catch((()=>({})));if(!e.ok){if(400===e.status){return void r(`Erro 400 ao criar: ${t?.error||t?.message||"Nome de instância inválido ou já existente."}`)}throw new Error(t?.error||`HTTP ${e.status}`)}const a=c(t),i=document.getElementById("qr-token");a&&i?(i.value=a,r("Instância criada e token preenchido.")):r("Instância criada, mas token não retornado. Verifique o backend.");try{d(t),await l(!0),r("QR solicitado automaticamente após criação. Escaneie para conectar.")}catch(e){r(`Aviso: falha ao gerar QR automaticamente: ${e.message}. Use os botões abaixo.`)}}catch(e){r(`Erro ao criar instância: ${e.message}`)}else r("Nome inválido. Use 3–32 caracteres: letras, números e hífen (sem hífen nas extremidades).");else r("Informe o nome da instância.")},window.qrConnectInstance=async function(){const e=document.getElementById("qr-phone")?.value?.trim()||"";if(!!(localStorage.getItem("authUser")||"").trim())try{const t=await window.authFetch(`${n}/user/connect-instance`,{method:"POST",headers:{"Content-Type":"application/json"},body:{phone:e}}),o=await t.json();if(!t.ok)throw new Error(o?.error||`HTTP ${t.status}`);r("Conexão iniciada. Renderizando QR/Paircode do retorno..."),d(o);let a=0;const c=setInterval((async()=>{a++;try{const e=await window.authFetch(`${n}/user/instance-status`,{method:"GET"}),t=await e.json().catch((()=>({})));if(Boolean(t?.connected||t?.ready||t?.loggedIn||t?.status?.connected||"connected"===t?.status)){clearInterval(c),r("Instância conectada. Você já pode enviar mensagens.");try{window.qrFlowLog&&window.qrFlowLog("qr.flow.poll_connected",{page:"index.js",tries:a})}catch(e){}}else if(a>=8){clearInterval(c);try{window.qrFlowLog&&window.qrFlowLog("qr.flow.poll_stopped_no_connect",{page:"index.js",tries:a})}catch(e){}try{await l(!0)}catch(e){}}}catch(e){}}),1e3)}catch(e){r(`Erro ao conectar: ${e.message}`)}else r("Faça login para conectar sua instância.")},window.qrGetQr=l,window.qrGetStatus=async function(){if(!!(localStorage.getItem("authUser")||"").trim())try{const e=await window.authFetch(`${n}/user/instance-status`,{method:"GET"}),t=await e.json().catch((()=>({})));if(e.ok){const e=Boolean(t?.status?.connected),n=document.getElementById("qr-status");n&&(n.textContent=e?"✅ WhatsApp conectado.":"❌ Instância não conectada.");try{r("Status da instância:\n"+JSON.stringify(t,null,2))}catch(e){}try{d(t)}catch(e){}}else r("❌ Erro ao obter status:\n"+JSON.stringify(t,null,2))}catch(e){r("❌ Erro de conexão ao obter status:\n"+e.message)}else r("Faça login para obter o status.")},window.qrCopyPaircode=function(){const e=document.getElementById("paircodeDisplay")?.value||"";e?navigator.clipboard.writeText(e).then((()=>{r("Paircode copiado para área de transferência.")})).catch((e=>r(`Falha ao copiar: ${e.message}`))):r("Nenhum paircode para copiar.")},window.disconnectInstance=u,window.qrConnectThenForceQr=m;let w=null,y=null;function h(){try{y&&(clearTimeout(y),y=null)}catch(e){}try{w&&(w.close(),w=null)}catch(e){}}window.__stopInstanceSse=h;const g=document.getElementById("btn-generate-qr"),p=document.getElementById("btn-force-qr"),f=document.getElementById("btn-disconnect-instance");g&&g.addEventListener("click",(()=>m())),p&&p.addEventListener("click",(()=>l(!0))),f&&f.addEventListener("click",(e=>{try{e&&"function"==typeof e.preventDefault&&e.preventDefault()}catch(e){}try{e&&"function"==typeof e.stopPropagation&&e.stopPropagation()}catch(e){}u()}))}();